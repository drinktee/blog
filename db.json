{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/material-flow/source/style.less","path":"style.less","modified":1,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.eot","path":"fonts/icomoon.eot","modified":1,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.ttf","path":"fonts/icomoon.ttf","modified":1,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.svg","path":"fonts/icomoon.svg","modified":1,"renderable":1},{"_id":"themes/material-flow/source/fonts/icomoon.woff","path":"fonts/icomoon.woff","modified":1,"renderable":1},{"_id":"themes/material-flow/source/fonts/selection.json","path":"fonts/selection.json","modified":1,"renderable":1},{"_id":"themes/material-flow/source/js/app.js","path":"js/app.js","modified":1,"renderable":1},{"_id":"themes/material-flow/source/js/jquery.fitvids.js","path":"js/jquery.fitvids.js","modified":1,"renderable":1},{"_id":"themes/material-flow/source/js/search.js","path":"js/search.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"053ebe622ea74c3b61abcc671bc96062b45abc83","modified":1492496661000},{"_id":"themes/material-flow/LICENSE","hash":"44409ab0bcd7853e2ac93faad84e57299711e6bf","modified":1494524404000},{"_id":"themes/material-flow/_config.yml","hash":"f8d46ea45cac29e57c67a4bafcdc48e2e939c574","modified":1494524817000},{"_id":"themes/material-flow/README.md","hash":"1d44569247362e7667fd472ceea120b682ebca86","modified":1494524404000},{"_id":"source/_posts/Kubernetes-1-6-集群部署.md","hash":"fa9e9668e0f4f7300901ca93135520cea74eaeb1","modified":1495281945000},{"_id":"source/about/index.md","hash":"15c1ceb43462f115caf8a086cedbf9e0fbbead49","modified":1492164447000},{"_id":"source/_posts/docker-run启动daemon-crash问题，An-error-occurred-trying-to-connect.md","hash":"ae1625faa76c71a3a80e696584fc7f44710cdda2","modified":1492311970000},{"_id":"themes/material-flow/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1494524404000},{"_id":"themes/material-flow/.git/config","hash":"82381cee1ab01284f0764b866b459e10a56a791b","modified":1494524404000},{"_id":"themes/material-flow/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1494524399000},{"_id":"themes/material-flow/.git/index","hash":"a6a3d6d4d193ae3ba828fb15236bbbffc5f662ca","modified":1495275912000},{"_id":"themes/material-flow/.git/packed-refs","hash":"2216b59d73464195bebfe207cef3571e678f2fc4","modified":1494524404000},{"_id":"themes/material-flow/layout/archive.ejs","hash":"735e6c0b1f8f837617b3a4119ac321a84f4ec5f7","modified":1494524404000},{"_id":"themes/material-flow/layout/category.ejs","hash":"c97be36b33bb44957778587f00c978f2d28016f8","modified":1494524404000},{"_id":"themes/material-flow/layout/layout.ejs","hash":"c137d708da9c5339dbcdf2e45c4851c08899a457","modified":1494524404000},{"_id":"themes/material-flow/layout/index.ejs","hash":"c97be36b33bb44957778587f00c978f2d28016f8","modified":1494524404000},{"_id":"themes/material-flow/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1494524404000},{"_id":"themes/material-flow/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1494524404000},{"_id":"themes/material-flow/layout/tag.ejs","hash":"c97be36b33bb44957778587f00c978f2d28016f8","modified":1494524404000},{"_id":"themes/material-flow/source/style.less","hash":"ad50444f75534f36001872d4c90e1d839614402b","modified":1494524404000},{"_id":"themes/material-flow/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/pre-commit.sample","hash":"36aed8976dcc08b5076844f0ec645b18bc37758f","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/pre-rebase.sample","hash":"5885a56ab4fca8075a05a562d005e922cde9853b","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/prepare-commit-msg.sample","hash":"2b6275eda365cad50d167fe3a387c9bc9fedd54f","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1494524399000},{"_id":"themes/material-flow/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1494524399000},{"_id":"themes/material-flow/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1494524399000},{"_id":"themes/material-flow/.git/logs/HEAD","hash":"aa798216a85c803118ac0d95f88a368c7bee394e","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/archive.ejs","hash":"7d811a088748b758c0664645629adbebdd8d1c3f","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/categories.ejs","hash":"761fda43c385e81324b628dfab6377b82bfdf82a","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/article.ejs","hash":"ae9c3e700397e1ec1963aa6d0ca1b3aab7e182a1","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/footer.ejs","hash":"a8d0ee768920a69818e0065a65a94109b72cb77d","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/head.ejs","hash":"e7e1f1b4d9830cf0a91efe6fcbabdbbd405567d0","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/header.ejs","hash":"7ee2448ebb96c206e449ea6641d5ba5cc1a6c9d2","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/loading.ejs","hash":"9c5721d5a5cff00860f2775b12dd73fe62375201","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/post.ejs","hash":"16d695e09c9d73e3e01b78f8b5385690d45d98a1","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/scripts.ejs","hash":"456c65e7c1f93c66511e0976ea88a744d3e6b7de","modified":1494524404000},{"_id":"themes/material-flow/layout/_partial/side.ejs","hash":"fe78dea06ac3a4ce2efcfd6171aea8fb3f64ebe7","modified":1494524404000},{"_id":"themes/material-flow/layout/_widget/about.ejs","hash":"3ca212dc0bb83fd9b338920f813667cfc2eda85e","modified":1494524404000},{"_id":"themes/material-flow/layout/_widget/links.ejs","hash":"2d6c7fc92b0330a7a79b8b680cf9f4286fdf0291","modified":1494524404000},{"_id":"themes/material-flow/layout/_widget/categories.ejs","hash":"2be2c85e4c5275d08e524fabdb38f046054b874a","modified":1494524404000},{"_id":"themes/material-flow/layout/_widget/tagcloud.ejs","hash":"914698bcc4210b5f984e12166eca3c86de631968","modified":1494524404000},{"_id":"themes/material-flow/source/fonts/icomoon.eot","hash":"931a892fd6307c0cfcbb71511ad4a38b3dd20edf","modified":1494524404000},{"_id":"themes/material-flow/source/fonts/icomoon.ttf","hash":"6192fb2b38c94f77d1fed08c1969fab5ffe9a30c","modified":1494524404000},{"_id":"themes/material-flow/source/fonts/icomoon.svg","hash":"37a9d40dfcd7d156cf452db75c425e797351e2b5","modified":1494524404000},{"_id":"themes/material-flow/source/fonts/icomoon.woff","hash":"0356e9be814a04187c641371fd95a7a8d9111200","modified":1494524404000},{"_id":"themes/material-flow/source/fonts/selection.json","hash":"498b5ba0cafb2eb5fa20f9034527eb912fa41827","modified":1494524404000},{"_id":"themes/material-flow/source/js/app.js","hash":"17aca227d841b932ac33af4c9e02a192832fdc85","modified":1494524404000},{"_id":"themes/material-flow/source/js/jquery.fitvids.js","hash":"57946a22c79654014eb00fb548f727d302221873","modified":1494524404000},{"_id":"themes/material-flow/source/less/_article.less","hash":"1b3047af7f04f9f767dbeaedfc980503b6f537f1","modified":1494524404000},{"_id":"themes/material-flow/source/less/_archive.less","hash":"0b15989a0d19ce550cf5d0021376c5ad1d4790b9","modified":1494524404000},{"_id":"themes/material-flow/source/less/_base.less","hash":"3eb0dd24a371d05a24672f0140aae7214ddf6877","modified":1494524404000},{"_id":"themes/material-flow/source/js/search.js","hash":"632ce023094442d350dcd2895ca5f948364746cb","modified":1494524404000},{"_id":"themes/material-flow/source/less/_defines.less","hash":"6b8ffd4e1b478e046722487bae15a500f3fd3092","modified":1494524404000},{"_id":"themes/material-flow/source/less/_fonts.less","hash":"d9e56fa5affcdee1c530ee5d5268a7e07644c05a","modified":1494524404000},{"_id":"themes/material-flow/source/less/_footer.less","hash":"973b1f9c62159f345833db5c30db03c351c66c5c","modified":1494524404000},{"_id":"themes/material-flow/source/less/_header.less","hash":"36f32479c42be1ed503903e1cb88daca5b7792ca","modified":1494524404000},{"_id":"themes/material-flow/snapshots/phone.png","hash":"8e78f25ee179e3ff27fff101050792184935d319","modified":1494524404000},{"_id":"themes/material-flow/source/less/_main.less","hash":"6e2c43e15d1e05bcddbccc1d4830b4687261f1eb","modified":1494524404000},{"_id":"themes/material-flow/source/less/_normalize.less","hash":"02fe53286d071637534d5aa2c57c76c168c0d521","modified":1494524404000},{"_id":"themes/material-flow/source/less/_pagination.less","hash":"165e2c369faf70858b731bb6d483d8991259887e","modified":1494524404000},{"_id":"themes/material-flow/source/less/_side.less","hash":"210ffc4e3fc41a5202618e17fc744a8b2b6bc54e","modified":1494524404000},{"_id":"themes/material-flow/source/less/_toc.less","hash":"76729eb95cf89eb17436e13610847102d4795a63","modified":1494524404000},{"_id":"themes/material-flow/source/less/_tog.less","hash":"bff0ab3b06e14a3c171ccd53061f8ccddb1e2fc2","modified":1494524404000},{"_id":"themes/material-flow/source/less/_search.less","hash":"ab1e3d8fdd489adde30723c40726e5e8187a8b6c","modified":1494524404000},{"_id":"themes/material-flow/source/less/_typo.less","hash":"8635fe95a08614f22833c6c159ebf6cf3d731e12","modified":1494524404000},{"_id":"themes/material-flow/source/less/_widget.less","hash":"a6fc757f2daf58089490eefe0701b9889a8bd4bd","modified":1494524404000},{"_id":"themes/material-flow/snapshots/article.png","hash":"3f1aff6057a807b55edd2435421b59a1f4e82c40","modified":1494524404000},{"_id":"themes/material-flow/.git/refs/heads/master","hash":"e70806944250345e81699a597d13fc8f41215803","modified":1494524404000},{"_id":"themes/material-flow/.git/objects/pack/pack-20da852e5fc5de3d6ea4c230346ca3e503a0dcb4.idx","hash":"145b03d58623d9728c454d9089a8a8bbf0b7151c","modified":1494524404000},{"_id":"themes/material-flow/.git/logs/refs/heads/master","hash":"aa798216a85c803118ac0d95f88a368c7bee394e","modified":1494524404000},{"_id":"themes/material-flow/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1494524404000},{"_id":"themes/material-flow/snapshots/index.png","hash":"a4aa937770d1573032f3e830be3cd75672a26036","modified":1494524404000},{"_id":"themes/material-flow/.git/logs/refs/remotes/origin/HEAD","hash":"aa798216a85c803118ac0d95f88a368c7bee394e","modified":1494524404000},{"_id":"themes/material-flow/.git/objects/pack/pack-20da852e5fc5de3d6ea4c230346ca3e503a0dcb4.pack","hash":"dcf10836ccaf8e9ed9e756fd0e9f4ba4d7b32f0d","modified":1494524404000},{"_id":"public/content.json","hash":"3f3d7e4ffde308340039db31d9c38df94bc2b0eb","modified":1495282180647},{"_id":"public/atom.xml","hash":"93d82f598f55fedcecff22e18e596b7e537cce14","modified":1495282180780},{"_id":"public/search.xml","hash":"06a53157109cdcf268f0a4da79991f5e231cbca7","modified":1495282180784},{"_id":"public/about/index.html","hash":"8194e8443ca7d5ddb8318a69282e34d3718c249c","modified":1495282180786},{"_id":"public/2017/04/16/docker-run启动daemon-crash问题，An-error-occurred-trying-to-connect/index.html","hash":"1870a14d9bbfd6e70f8f70c53f88852363d3ad9c","modified":1495282180786},{"_id":"public/archives/index.html","hash":"c5ab4491af62079eaebce0ca4db47f89055ab57d","modified":1495282180786},{"_id":"public/archives/2017/04/index.html","hash":"d60077876856b9876744991c27b0c0f10a9fb173","modified":1495282180786},{"_id":"public/2017/05/20/Kubernetes-1-6-集群部署/index.html","hash":"46f60eed51aa052f819cd6a90955daebaa3623b4","modified":1495282180786},{"_id":"public/archives/2017/index.html","hash":"47a7026c18af1c1aeae9af84ff740e1068c5d42e","modified":1495282180786},{"_id":"public/archives/2017/05/index.html","hash":"187dc94a64d01ebd1e263206b76d1340f5c407b0","modified":1495282180786},{"_id":"public/index.html","hash":"5f296bcac810e49da2c05f0d7ee7638af5993e28","modified":1495282180786},{"_id":"public/fonts/icomoon.eot","hash":"931a892fd6307c0cfcbb71511ad4a38b3dd20edf","modified":1495282180789},{"_id":"public/fonts/icomoon.ttf","hash":"6192fb2b38c94f77d1fed08c1969fab5ffe9a30c","modified":1495282180789},{"_id":"public/fonts/icomoon.svg","hash":"37a9d40dfcd7d156cf452db75c425e797351e2b5","modified":1495282180789},{"_id":"public/fonts/icomoon.woff","hash":"0356e9be814a04187c641371fd95a7a8d9111200","modified":1495282180789},{"_id":"public/js/app.js","hash":"17aca227d841b932ac33af4c9e02a192832fdc85","modified":1495282180809},{"_id":"public/js/jquery.fitvids.js","hash":"57946a22c79654014eb00fb548f727d302221873","modified":1495282180809},{"_id":"public/fonts/selection.json","hash":"c38f13105ee7c35a67476dd80eaa2ffd037c124b","modified":1495282180809},{"_id":"public/js/search.js","hash":"632ce023094442d350dcd2895ca5f948364746cb","modified":1495282180810},{"_id":"public/style.css","hash":"81bb06988795b416ad5034d160b0bdc8a42139e9","modified":1495282181117}],"Category":[],"Data":[],"Page":[{"title":"about me","date":"2017-04-14T10:02:30.000Z","_content":"\n\n### Email: zjsxzong89@gmail.com","source":"about/index.md","raw":"---\ntitle: about me\ndate: 2017-04-14 18:02:30\n---\n\n\n### Email: zjsxzong89@gmail.com","updated":"2017-04-14T10:07:27.000Z","path":"about/index.html","comments":1,"layout":"page","_id":"cj2x8eiee0000mconhydjggz8","content":"<h3 id=\"Email-zjsxzong89-gmail-com\"><a href=\"#Email-zjsxzong89-gmail-com\" class=\"headerlink\" title=\"Email: zjsxzong89@gmail.com\"></a>Email: zjsxzong89@gmail.com</h3>","site":{"data":{}},"excerpt":"","more":"<h3 id=\"Email-zjsxzong89-gmail-com\"><a href=\"#Email-zjsxzong89-gmail-com\" class=\"headerlink\" title=\"Email: zjsxzong89@gmail.com\"></a>Email: zjsxzong89@gmail.com</h3>"}],"Post":[{"title":"Kubernetes 1.6 集群部署","date":"2017-05-20T10:27:01.000Z","_content":"\n# Kubernetes 1.6 集群部署\n\n# 环境准备\n\n- 需要先升级内核到3.10以上\n\n### 下载安装包\n\n```bash\nwget https://dl.k8s.io/v1.6.2/kubernetes-server-linux-amd64.tar.gz\ntar -zxvf kubernetes-server-linux-amd64.tar.gz\n```\n\n### 系统配置\n\n在各节点创建/etc/sysctl.d/k8s.conf文件，添加如下内容：\n\n```bash\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\n```\n\n执行命令使修改生效\n\n```bash\nsetenforce 0\nvi /etc/selinux/config\nSELINUX=disabled\n```\n\n### ETCD集群，Docker安装\n\netcd集群采用高可用，三节点部署，启用TLS。在每个node上安装好docker。\n\n# Kubernetes各组件TLS证书和密钥生成\n\n使用[CFSSL](https://github.com/cloudflare/cfssl)来生成证书和密钥。\n\n### 生成CA证书和私钥\n\n`ca-config.json`文件\n\n```json\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"frognew\": {\n        \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ],\n        \"expiry\": \"87600h\"\n      }\n    }\n  }\n}\n```\n\n创建CA证书签名请求配置ca-csr.json：\n\n```json\n{\n  \"CN\": \"kubernetes\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"k8s\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n使用cfssl生成CA证书和私钥\n\n```bash\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca\n```\n\n### 生成kube-apiserver证书和私钥\n\n有三个master节点，\"11.1.0.1\"是api-server的service ip\napiserver-csr.json：\n\n```bash\n{\n    \"CN\": \"kubernetes\",\n    \"hosts\": [\n      \"127.0.0.1\",\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"11.1.0.1\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\",\n      \"kubernetes\",\n      \"kubernetes.default\",\n      \"kubernetes.default.svc\",\n      \"kubernetes.default.svc.cluster\",\n      \"kubernetes.default.svc.cluster.local\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"BeiJing\",\n            \"L\": \"BeiJing\",\n            \"O\": \"k8s\",\n            \"OU\": \"cloudnative\"\n        }\n    ]\n}\n```\n\n然后生成kube-apiserver的证书和私钥：\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew apiserver-csr.json | cfssljson -bare apiserver\nls apiserver*\napiserver.csr  apiserver-csr.json  apiserver-key.pem  apiserver.pem\n```\n\n### 创建kubernetes-admin客户端证书和私钥\n\n```json\n{\n  \"CN\": \"kubernetes-admin\",\n  \"hosts\": [\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n生成kubernetes-admin的证书和私钥：\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew admin-csr.json | cfssljson -bare admin\n```\n\n### 生成kube-controller-manager证书和私钥\n\n```json\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"hosts\": [\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:kube-controller-manager\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n生成证书和私钥\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew controller-manager-csr.json | cfssljson -bare controller-manager\n```\n\n### 生成kube-scheduler证书和私钥\n\nscheduler-csr.json：\n\n```json\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"hosts\": [\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:kube-scheduler\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n命令仍然类似\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew scheduler-csr.json | cfssljson -bare scheduler\n```\n\n# 部署三个master节点\n\n三个节点需要先拷贝好各组件的证书与密钥，参考的组件启动参数如下。\n\n*注意：这里没有做高可用！*\n\n### kube-apiserver\n\n```bash\n/home/work/kube_apiserver/bin/kube-apiserver \\\n--bind-address=0.0.0.0 --insecure-port=8080 \\\n--secure-port=8443  \\\n--etcd_servers=https://master-mgr00:2379,\\\nhttps://master-mgr01:2379, \\\nhttps://master-mgr02:2379 \\\n--apiserver-count=3 --logtostderr=true --allow-privileged=true \\\n--tls-cert-file=/home/work/kube_apiserver/conf/apiserver.pem \\\n--tls-private-key-file=/home/work/kube_apiserver/conf/apiserver-key.pem \\\n--client-ca-file=/home/work/kube_apiserver/conf/ca.pem \\\n--service-account-key-file=/home/work/kube_apiserver/conf/ca-key.pem \\\n--etcd-cafile=/home/work/kube_apiserver/conf/etcd/ca.pem \\\n--etcd-certfile=/home/work/kube_apiserver/conf/etcd/etcd.pem \\\n--etcd-keyfile=/home/work/kube_apiserver/conf/etcd/etcd-key.pem \\\n--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,\\\nPersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds \\\n--authorization-mode=RBAC --service-cluster-ip-range=11.1.0.0/16\n```\n\n### kube-controller-manager\n\n```bash\n/home/work/kube_controller_manager/bin/kube-controller-manager \\\n--address=0.0.0.0 --master=http://127.0.0.1:8080 \\\n--leader-elect=true --logtostderr=true \\\n --cluster-cidr=172.17.0.0/16 --allocate-node-cidrs=true \\\n --service-cluster-ip-range=11.1.0.0/16 \\\n --service-account-private-key-file=/home/work/kube_controller_manager/conf/ca-key.pem \\\n --root-ca-file=/home/work/kube_controller_manager/conf/ca.pem\n```\n\n### kube-scheduler\n\n```bash\n/home/work/kube_scheduler/bin/kube-scheduler \\\n--address=0.0.0.0 --leader-elect=true --logtostderr=true \\\n--master=http://127.0.0.1:8080\n```\n\n# Kubernetes Node节点部署\n\n- 部分机器要先安装下载`nsenter`这个二进制工具到bin目录\n\n### CNI安装\n\n```bash\nwget https://github.com/containernetworking/cni/releases/download/v0.5.2/cni-amd64-v0.5.2.tgz\nmkdir -p /opt/cni/bin\ntar -zxvf cni-amd64-v0.5.2.tgz -C /opt/cni/bin\nls /opt/cni/bin/\nbridge  cnitool  dhcp  flannel  host-local  ipvlan  loopback  macvlan  noop  ptp  tuning\n```\n\n### kubelet\n\nkubelet-csr.json：\n\n```json\n{\n  \"CN\": \"system:node\",\n  \"hosts\": [\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:nodes\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kubelet-csr.json | cfssljson -bare kubelet\n```\n\n启动参数\n\n```bash\n /home/work/kubelet/bin/kubelet --address=0.0.0.0 \\\n --api-servers=https://master-mgr00:8443,https://master-mgr00:8443,https://master-mgr00:8443 \\\n --pod_infra_container_image=registry.baidu.com/public/pause:2.0 \\\n --cluster-domain=cluster.local --cluster-dns=11.1.0.10 \\\n --logtostderr=true \\\n  --client-ca-file=/home/work/kubelet/conf/ca.pem \\\n  --tls-private-key-file=/home/work/kubelet/conf/kubelet-key.pem \\\n  --tls-cert-file=/home/work/kubelet/conf/kubelet.pem \\\n  --kubeconfig=/home/work/kubelet/conf/kubeconfig.yaml \\\n  --allow-privileged=true --cgroups-per-qos=false \\\n  --enforce-node-allocatable= --network-plugin=cni \\\n  --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin \\\n  --cadvisor-port=8086\n```\n\n\n### kube-proxy\n\nkube-proxy-csr.json:\n\n```json\n{\n  \"CN\": \"system:kube-proxy\",\n  \"hosts\": [\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:kube-proxy\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kube-proxy-csr.json | cfssljson -bare kube-proxy\n```\n\n生成kubeconfig：\n\n```bash\nexport KUBE_APISERVER=\"https://master-mgr00:8443\"\n# set-cluster\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/home/work/kube_proxy/conf/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=kube-proxy.conf\n# set-credentials\nkubectl config set-credentials system:kube-proxy \\\n  --client-certificate=/home/work/kube_proxy/conf/kube-proxy.pem \\\n  --embed-certs=true \\\n  --client-key=/home/work/kube_proxy/conf/kube-proxy-key.pem \\\n  --kubeconfig=kube-proxy.conf\n# set-context\nkubectl config set-context system:kube-proxy@kubernetes \\\n  --cluster=kubernetes \\\n  --user=system:kube-proxy \\\n  --kubeconfig=kube-proxy.conf\n# set default context\nkubectl config use-context system:kube-proxy@kubernetes --kubeconfig=kube-proxy.conf\n```\n\n启动命令\n\n```bash\n /home/work/kube_proxy/bin/kube-proxy --master=https://master-mgr00:8443 \\\n --kubeconfig=/home/work/kube_proxy/conf/kube-proxy.conf \\\n --proxy-mode=iptables --cluster-cidr=172.17.0.0/16 \\\n --logtostderr=true\n```\n\n# 总结\n\n后续还要部署flannel，dns等其他插件，将写在下一篇博客里了。","source":"_posts/Kubernetes-1-6-集群部署.md","raw":"---\ntitle: Kubernetes 1.6 集群部署\ndate: 2017-05-20 18:27:01\ntags:\n---\n\n# Kubernetes 1.6 集群部署\n\n# 环境准备\n\n- 需要先升级内核到3.10以上\n\n### 下载安装包\n\n```bash\nwget https://dl.k8s.io/v1.6.2/kubernetes-server-linux-amd64.tar.gz\ntar -zxvf kubernetes-server-linux-amd64.tar.gz\n```\n\n### 系统配置\n\n在各节点创建/etc/sysctl.d/k8s.conf文件，添加如下内容：\n\n```bash\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\n```\n\n执行命令使修改生效\n\n```bash\nsetenforce 0\nvi /etc/selinux/config\nSELINUX=disabled\n```\n\n### ETCD集群，Docker安装\n\netcd集群采用高可用，三节点部署，启用TLS。在每个node上安装好docker。\n\n# Kubernetes各组件TLS证书和密钥生成\n\n使用[CFSSL](https://github.com/cloudflare/cfssl)来生成证书和密钥。\n\n### 生成CA证书和私钥\n\n`ca-config.json`文件\n\n```json\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"frognew\": {\n        \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ],\n        \"expiry\": \"87600h\"\n      }\n    }\n  }\n}\n```\n\n创建CA证书签名请求配置ca-csr.json：\n\n```json\n{\n  \"CN\": \"kubernetes\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"k8s\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n使用cfssl生成CA证书和私钥\n\n```bash\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca\n```\n\n### 生成kube-apiserver证书和私钥\n\n有三个master节点，\"11.1.0.1\"是api-server的service ip\napiserver-csr.json：\n\n```bash\n{\n    \"CN\": \"kubernetes\",\n    \"hosts\": [\n      \"127.0.0.1\",\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"11.1.0.1\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\",\n      \"kubernetes\",\n      \"kubernetes.default\",\n      \"kubernetes.default.svc\",\n      \"kubernetes.default.svc.cluster\",\n      \"kubernetes.default.svc.cluster.local\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"ST\": \"BeiJing\",\n            \"L\": \"BeiJing\",\n            \"O\": \"k8s\",\n            \"OU\": \"cloudnative\"\n        }\n    ]\n}\n```\n\n然后生成kube-apiserver的证书和私钥：\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew apiserver-csr.json | cfssljson -bare apiserver\nls apiserver*\napiserver.csr  apiserver-csr.json  apiserver-key.pem  apiserver.pem\n```\n\n### 创建kubernetes-admin客户端证书和私钥\n\n```json\n{\n  \"CN\": \"kubernetes-admin\",\n  \"hosts\": [\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n生成kubernetes-admin的证书和私钥：\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew admin-csr.json | cfssljson -bare admin\n```\n\n### 生成kube-controller-manager证书和私钥\n\n```json\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"hosts\": [\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:kube-controller-manager\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n生成证书和私钥\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew controller-manager-csr.json | cfssljson -bare controller-manager\n```\n\n### 生成kube-scheduler证书和私钥\n\nscheduler-csr.json：\n\n```json\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"hosts\": [\n      \"10.73.212.42\",\n      \"10.73.213.14\",\n      \"10.73.213.31\",\n      \"master-mgr00\",\n      \"master-mgr01\",\n      \"master-mgr02\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:kube-scheduler\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n命令仍然类似\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew scheduler-csr.json | cfssljson -bare scheduler\n```\n\n# 部署三个master节点\n\n三个节点需要先拷贝好各组件的证书与密钥，参考的组件启动参数如下。\n\n*注意：这里没有做高可用！*\n\n### kube-apiserver\n\n```bash\n/home/work/kube_apiserver/bin/kube-apiserver \\\n--bind-address=0.0.0.0 --insecure-port=8080 \\\n--secure-port=8443  \\\n--etcd_servers=https://master-mgr00:2379,\\\nhttps://master-mgr01:2379, \\\nhttps://master-mgr02:2379 \\\n--apiserver-count=3 --logtostderr=true --allow-privileged=true \\\n--tls-cert-file=/home/work/kube_apiserver/conf/apiserver.pem \\\n--tls-private-key-file=/home/work/kube_apiserver/conf/apiserver-key.pem \\\n--client-ca-file=/home/work/kube_apiserver/conf/ca.pem \\\n--service-account-key-file=/home/work/kube_apiserver/conf/ca-key.pem \\\n--etcd-cafile=/home/work/kube_apiserver/conf/etcd/ca.pem \\\n--etcd-certfile=/home/work/kube_apiserver/conf/etcd/etcd.pem \\\n--etcd-keyfile=/home/work/kube_apiserver/conf/etcd/etcd-key.pem \\\n--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,\\\nPersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds \\\n--authorization-mode=RBAC --service-cluster-ip-range=11.1.0.0/16\n```\n\n### kube-controller-manager\n\n```bash\n/home/work/kube_controller_manager/bin/kube-controller-manager \\\n--address=0.0.0.0 --master=http://127.0.0.1:8080 \\\n--leader-elect=true --logtostderr=true \\\n --cluster-cidr=172.17.0.0/16 --allocate-node-cidrs=true \\\n --service-cluster-ip-range=11.1.0.0/16 \\\n --service-account-private-key-file=/home/work/kube_controller_manager/conf/ca-key.pem \\\n --root-ca-file=/home/work/kube_controller_manager/conf/ca.pem\n```\n\n### kube-scheduler\n\n```bash\n/home/work/kube_scheduler/bin/kube-scheduler \\\n--address=0.0.0.0 --leader-elect=true --logtostderr=true \\\n--master=http://127.0.0.1:8080\n```\n\n# Kubernetes Node节点部署\n\n- 部分机器要先安装下载`nsenter`这个二进制工具到bin目录\n\n### CNI安装\n\n```bash\nwget https://github.com/containernetworking/cni/releases/download/v0.5.2/cni-amd64-v0.5.2.tgz\nmkdir -p /opt/cni/bin\ntar -zxvf cni-amd64-v0.5.2.tgz -C /opt/cni/bin\nls /opt/cni/bin/\nbridge  cnitool  dhcp  flannel  host-local  ipvlan  loopback  macvlan  noop  ptp  tuning\n```\n\n### kubelet\n\nkubelet-csr.json：\n\n```json\n{\n  \"CN\": \"system:node\",\n  \"hosts\": [\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:nodes\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kubelet-csr.json | cfssljson -bare kubelet\n```\n\n启动参数\n\n```bash\n /home/work/kubelet/bin/kubelet --address=0.0.0.0 \\\n --api-servers=https://master-mgr00:8443,https://master-mgr00:8443,https://master-mgr00:8443 \\\n --pod_infra_container_image=registry.baidu.com/public/pause:2.0 \\\n --cluster-domain=cluster.local --cluster-dns=11.1.0.10 \\\n --logtostderr=true \\\n  --client-ca-file=/home/work/kubelet/conf/ca.pem \\\n  --tls-private-key-file=/home/work/kubelet/conf/kubelet-key.pem \\\n  --tls-cert-file=/home/work/kubelet/conf/kubelet.pem \\\n  --kubeconfig=/home/work/kubelet/conf/kubeconfig.yaml \\\n  --allow-privileged=true --cgroups-per-qos=false \\\n  --enforce-node-allocatable= --network-plugin=cni \\\n  --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin \\\n  --cadvisor-port=8086\n```\n\n\n### kube-proxy\n\nkube-proxy-csr.json:\n\n```json\n{\n  \"CN\": \"system:kube-proxy\",\n  \"hosts\": [\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"BeiJing\",\n      \"L\": \"BeiJing\",\n      \"O\": \"system:kube-proxy\",\n      \"OU\": \"cloudnative\"\n    }\n  ]\n}\n```\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kube-proxy-csr.json | cfssljson -bare kube-proxy\n```\n\n生成kubeconfig：\n\n```bash\nexport KUBE_APISERVER=\"https://master-mgr00:8443\"\n# set-cluster\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/home/work/kube_proxy/conf/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=kube-proxy.conf\n# set-credentials\nkubectl config set-credentials system:kube-proxy \\\n  --client-certificate=/home/work/kube_proxy/conf/kube-proxy.pem \\\n  --embed-certs=true \\\n  --client-key=/home/work/kube_proxy/conf/kube-proxy-key.pem \\\n  --kubeconfig=kube-proxy.conf\n# set-context\nkubectl config set-context system:kube-proxy@kubernetes \\\n  --cluster=kubernetes \\\n  --user=system:kube-proxy \\\n  --kubeconfig=kube-proxy.conf\n# set default context\nkubectl config use-context system:kube-proxy@kubernetes --kubeconfig=kube-proxy.conf\n```\n\n启动命令\n\n```bash\n /home/work/kube_proxy/bin/kube-proxy --master=https://master-mgr00:8443 \\\n --kubeconfig=/home/work/kube_proxy/conf/kube-proxy.conf \\\n --proxy-mode=iptables --cluster-cidr=172.17.0.0/16 \\\n --logtostderr=true\n```\n\n# 总结\n\n后续还要部署flannel，dns等其他插件，将写在下一篇博客里了。","slug":"Kubernetes-1-6-集群部署","published":1,"updated":"2017-05-20T12:05:45.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2x8eieg0001mconhjoovtco","content":"<h1 id=\"Kubernetes-1-6-集群部署\"><a href=\"#Kubernetes-1-6-集群部署\" class=\"headerlink\" title=\"Kubernetes 1.6 集群部署\"></a>Kubernetes 1.6 集群部署</h1><h1 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h1><ul>\n<li>需要先升级内核到3.10以上</li>\n</ul>\n<h3 id=\"下载安装包\"><a href=\"#下载安装包\" class=\"headerlink\" title=\"下载安装包\"></a>下载安装包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget https://dl.k8s.io/v1.6.2/kubernetes-server-linux-amd64.tar.gz</div><div class=\"line\">tar -zxvf kubernetes-server-linux-amd64.tar.gz</div></pre></td></tr></table></figure>\n<h3 id=\"系统配置\"><a href=\"#系统配置\" class=\"headerlink\" title=\"系统配置\"></a>系统配置</h3><p>在各节点创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</div><div class=\"line\">net.bridge.bridge-nf-call-iptables = 1</div></pre></td></tr></table></figure>\n<p>执行命令使修改生效</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">setenforce 0</div><div class=\"line\">vi /etc/selinux/config</div><div class=\"line\">SELINUX=disabled</div></pre></td></tr></table></figure>\n<h3 id=\"ETCD集群，Docker安装\"><a href=\"#ETCD集群，Docker安装\" class=\"headerlink\" title=\"ETCD集群，Docker安装\"></a>ETCD集群，Docker安装</h3><p>etcd集群采用高可用，三节点部署，启用TLS。在每个node上安装好docker。</p>\n<h1 id=\"Kubernetes各组件TLS证书和密钥生成\"><a href=\"#Kubernetes各组件TLS证书和密钥生成\" class=\"headerlink\" title=\"Kubernetes各组件TLS证书和密钥生成\"></a>Kubernetes各组件TLS证书和密钥生成</h1><p>使用<a href=\"https://github.com/cloudflare/cfssl\" target=\"_blank\" rel=\"external\">CFSSL</a>来生成证书和密钥。</p>\n<h3 id=\"生成CA证书和私钥\"><a href=\"#生成CA证书和私钥\" class=\"headerlink\" title=\"生成CA证书和私钥\"></a>生成CA证书和私钥</h3><p><code>ca-config.json</code>文件</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"signing\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"default\"</span>: &#123;</div><div class=\"line\">      <span class=\"attr\">\"expiry\"</span>: <span class=\"string\">\"87600h\"</span></div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"attr\">\"profiles\"</span>: &#123;</div><div class=\"line\">      <span class=\"attr\">\"frognew\"</span>: &#123;</div><div class=\"line\">        <span class=\"attr\">\"usages\"</span>: [</div><div class=\"line\">            <span class=\"string\">\"signing\"</span>,</div><div class=\"line\">            <span class=\"string\">\"key encipherment\"</span>,</div><div class=\"line\">            <span class=\"string\">\"server auth\"</span>,</div><div class=\"line\">            <span class=\"string\">\"client auth\"</span></div><div class=\"line\">        ],</div><div class=\"line\">        <span class=\"attr\">\"expiry\"</span>: <span class=\"string\">\"87600h\"</span></div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>创建CA证书签名请求配置ca-csr.json：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"kubernetes\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"k8s\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>使用cfssl生成CA证书和私钥</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div></pre></td></tr></table></figure>\n<h3 id=\"生成kube-apiserver证书和私钥\"><a href=\"#生成kube-apiserver证书和私钥\" class=\"headerlink\" title=\"生成kube-apiserver证书和私钥\"></a>生成kube-apiserver证书和私钥</h3><p>有三个master节点，”11.1.0.1”是api-server的service ip<br>apiserver-csr.json：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"string\">\"CN\"</span>: <span class=\"string\">\"kubernetes\"</span>,</div><div class=\"line\">    <span class=\"string\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"127.0.0.1\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"11.1.0.1\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default.svc\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default.svc.cluster\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default.svc.cluster.local\"</span></div><div class=\"line\">    ],</div><div class=\"line\">    <span class=\"string\">\"key\"</span>: &#123;</div><div class=\"line\">        <span class=\"string\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">        <span class=\"string\">\"size\"</span>: 2048</div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"string\">\"names\"</span>: [</div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"string\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">            <span class=\"string\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">            <span class=\"string\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">            <span class=\"string\">\"O\"</span>: <span class=\"string\">\"k8s\"</span>,</div><div class=\"line\">            <span class=\"string\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">        &#125;</div><div class=\"line\">    ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>然后生成kube-apiserver的证书和私钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew apiserver-csr.json | cfssljson -bare apiserver</div><div class=\"line\">ls apiserver*</div><div class=\"line\">apiserver.csr  apiserver-csr.json  apiserver-key.pem  apiserver.pem</div></pre></td></tr></table></figure>\n<h3 id=\"创建kubernetes-admin客户端证书和私钥\"><a href=\"#创建kubernetes-admin客户端证书和私钥\" class=\"headerlink\" title=\"创建kubernetes-admin客户端证书和私钥\"></a>创建kubernetes-admin客户端证书和私钥</h3><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"kubernetes-admin\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:masters\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>生成kubernetes-admin的证书和私钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew admin-csr.json | cfssljson -bare admin</div></pre></td></tr></table></figure>\n<h3 id=\"生成kube-controller-manager证书和私钥\"><a href=\"#生成kube-controller-manager证书和私钥\" class=\"headerlink\" title=\"生成kube-controller-manager证书和私钥\"></a>生成kube-controller-manager证书和私钥</h3><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:kube-controller-manager\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:kube-controller-manager\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>生成证书和私钥</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew controller-manager-csr.json | cfssljson -bare controller-manager</div></pre></td></tr></table></figure>\n<h3 id=\"生成kube-scheduler证书和私钥\"><a href=\"#生成kube-scheduler证书和私钥\" class=\"headerlink\" title=\"生成kube-scheduler证书和私钥\"></a>生成kube-scheduler证书和私钥</h3><p>scheduler-csr.json：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:kube-scheduler\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:kube-scheduler\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>命令仍然类似</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew scheduler-csr.json | cfssljson -bare scheduler</div></pre></td></tr></table></figure>\n<h1 id=\"部署三个master节点\"><a href=\"#部署三个master节点\" class=\"headerlink\" title=\"部署三个master节点\"></a>部署三个master节点</h1><p>三个节点需要先拷贝好各组件的证书与密钥，参考的组件启动参数如下。</p>\n<p><em>注意：这里没有做高可用！</em></p>\n<h3 id=\"kube-apiserver\"><a href=\"#kube-apiserver\" class=\"headerlink\" title=\"kube-apiserver\"></a>kube-apiserver</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_apiserver/bin/kube-apiserver \\</div><div class=\"line\">--bind-address=0.0.0.0 --insecure-port=8080 \\</div><div class=\"line\">--secure-port=8443  \\</div><div class=\"line\">--etcd_servers=https://master-mgr00:2379,\\</div><div class=\"line\">https://master-mgr01:2379, \\</div><div class=\"line\">https://master-mgr02:2379 \\</div><div class=\"line\">--apiserver-count=3 --logtostderr=<span class=\"literal\">true</span> --allow-privileged=<span class=\"literal\">true</span> \\</div><div class=\"line\">--tls-cert-file=/home/work/kube_apiserver/conf/apiserver.pem \\</div><div class=\"line\">--tls-private-key-file=/home/work/kube_apiserver/conf/apiserver-key.pem \\</div><div class=\"line\">--client-ca-file=/home/work/kube_apiserver/conf/ca.pem \\</div><div class=\"line\">--service-account-key-file=/home/work/kube_apiserver/conf/ca-key.pem \\</div><div class=\"line\">--etcd-cafile=/home/work/kube_apiserver/conf/etcd/ca.pem \\</div><div class=\"line\">--etcd-certfile=/home/work/kube_apiserver/conf/etcd/etcd.pem \\</div><div class=\"line\">--etcd-keyfile=/home/work/kube_apiserver/conf/etcd/etcd-key.pem \\</div><div class=\"line\">--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,\\</div><div class=\"line\">PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds \\</div><div class=\"line\">--authorization-mode=RBAC --service-cluster-ip-range=11.1.0.0/16</div></pre></td></tr></table></figure>\n<h3 id=\"kube-controller-manager\"><a href=\"#kube-controller-manager\" class=\"headerlink\" title=\"kube-controller-manager\"></a>kube-controller-manager</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_controller_manager/bin/kube-controller-manager \\</div><div class=\"line\">--address=0.0.0.0 --master=http://127.0.0.1:8080 \\</div><div class=\"line\">--leader-elect=<span class=\"literal\">true</span> --logtostderr=<span class=\"literal\">true</span> \\</div><div class=\"line\"> --cluster-cidr=172.17.0.0/16 --allocate-node-cidrs=<span class=\"literal\">true</span> \\</div><div class=\"line\"> --service-cluster-ip-range=11.1.0.0/16 \\</div><div class=\"line\"> --service-account-private-key-file=/home/work/kube_controller_manager/conf/ca-key.pem \\</div><div class=\"line\"> --root-ca-file=/home/work/kube_controller_manager/conf/ca.pem</div></pre></td></tr></table></figure>\n<h3 id=\"kube-scheduler\"><a href=\"#kube-scheduler\" class=\"headerlink\" title=\"kube-scheduler\"></a>kube-scheduler</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_scheduler/bin/kube-scheduler \\</div><div class=\"line\">--address=0.0.0.0 --leader-elect=<span class=\"literal\">true</span> --logtostderr=<span class=\"literal\">true</span> \\</div><div class=\"line\">--master=http://127.0.0.1:8080</div></pre></td></tr></table></figure>\n<h1 id=\"Kubernetes-Node节点部署\"><a href=\"#Kubernetes-Node节点部署\" class=\"headerlink\" title=\"Kubernetes Node节点部署\"></a>Kubernetes Node节点部署</h1><ul>\n<li>部分机器要先安装下载<code>nsenter</code>这个二进制工具到bin目录</li>\n</ul>\n<h3 id=\"CNI安装\"><a href=\"#CNI安装\" class=\"headerlink\" title=\"CNI安装\"></a>CNI安装</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget https://github.com/containernetworking/cni/releases/download/v0.5.2/cni-amd64-v0.5.2.tgz</div><div class=\"line\">mkdir -p /opt/cni/bin</div><div class=\"line\">tar -zxvf cni-amd64-v0.5.2.tgz -C /opt/cni/bin</div><div class=\"line\">ls /opt/cni/bin/</div><div class=\"line\">bridge  cnitool  dhcp  flannel  host-local  ipvlan  loopback  macvlan  noop  ptp  tuning</div></pre></td></tr></table></figure>\n<h3 id=\"kubelet\"><a href=\"#kubelet\" class=\"headerlink\" title=\"kubelet\"></a>kubelet</h3><p>kubelet-csr.json：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:node\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:nodes\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kubelet-csr.json | cfssljson -bare kubelet</div></pre></td></tr></table></figure>\n<p>启动参数</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kubelet/bin/kubelet --address=0.0.0.0 \\</div><div class=\"line\">--api-servers=https://master-mgr00:8443,https://master-mgr00:8443,https://master-mgr00:8443 \\</div><div class=\"line\">--pod_infra_container_image=registry.baidu.com/public/pause:2.0 \\</div><div class=\"line\">--cluster-domain=cluster.local --cluster-dns=11.1.0.10 \\</div><div class=\"line\">--logtostderr=<span class=\"literal\">true</span> \\</div><div class=\"line\"> --client-ca-file=/home/work/kubelet/conf/ca.pem \\</div><div class=\"line\"> --tls-private-key-file=/home/work/kubelet/conf/kubelet-key.pem \\</div><div class=\"line\"> --tls-cert-file=/home/work/kubelet/conf/kubelet.pem \\</div><div class=\"line\"> --kubeconfig=/home/work/kubelet/conf/kubeconfig.yaml \\</div><div class=\"line\"> --allow-privileged=<span class=\"literal\">true</span> --cgroups-per-qos=<span class=\"literal\">false</span> \\</div><div class=\"line\"> --enforce-node-allocatable= --network-plugin=cni \\</div><div class=\"line\"> --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin \\</div><div class=\"line\"> --cadvisor-port=8086</div></pre></td></tr></table></figure>\n<h3 id=\"kube-proxy\"><a href=\"#kube-proxy\" class=\"headerlink\" title=\"kube-proxy\"></a>kube-proxy</h3><p>kube-proxy-csr.json:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:kube-proxy\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:kube-proxy\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kube-proxy-csr.json | cfssljson -bare kube-proxy</div></pre></td></tr></table></figure>\n<p>生成kubeconfig：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">export</span> KUBE_APISERVER=<span class=\"string\">\"https://master-mgr00:8443\"</span></div><div class=\"line\"><span class=\"comment\"># set-cluster</span></div><div class=\"line\">kubectl config <span class=\"built_in\">set</span>-cluster kubernetes \\</div><div class=\"line\">  --certificate-authority=/home/work/kube_proxy/conf/ca.pem \\</div><div class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</div><div class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</div><div class=\"line\">  --kubeconfig=kube-proxy.conf</div><div class=\"line\"><span class=\"comment\"># set-credentials</span></div><div class=\"line\">kubectl config <span class=\"built_in\">set</span>-credentials system:kube-proxy \\</div><div class=\"line\">  --client-certificate=/home/work/kube_proxy/conf/kube-proxy.pem \\</div><div class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</div><div class=\"line\">  --client-key=/home/work/kube_proxy/conf/kube-proxy-key.pem \\</div><div class=\"line\">  --kubeconfig=kube-proxy.conf</div><div class=\"line\"><span class=\"comment\"># set-context</span></div><div class=\"line\">kubectl config <span class=\"built_in\">set</span>-context system:kube-proxy@kubernetes \\</div><div class=\"line\">  --cluster=kubernetes \\</div><div class=\"line\">  --user=system:kube-proxy \\</div><div class=\"line\">  --kubeconfig=kube-proxy.conf</div><div class=\"line\"><span class=\"comment\"># set default context</span></div><div class=\"line\">kubectl config use-context system:kube-proxy@kubernetes --kubeconfig=kube-proxy.conf</div></pre></td></tr></table></figure>\n<p>启动命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_proxy/bin/kube-proxy --master=https://master-mgr00:8443 \\</div><div class=\"line\">--kubeconfig=/home/work/kube_proxy/conf/kube-proxy.conf \\</div><div class=\"line\">--proxy-mode=iptables --cluster-cidr=172.17.0.0/16 \\</div><div class=\"line\">--logtostderr=<span class=\"literal\">true</span></div></pre></td></tr></table></figure>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>后续还要部署flannel，dns等其他插件，将写在下一篇博客里了。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Kubernetes-1-6-集群部署\"><a href=\"#Kubernetes-1-6-集群部署\" class=\"headerlink\" title=\"Kubernetes 1.6 集群部署\"></a>Kubernetes 1.6 集群部署</h1><h1 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h1><ul>\n<li>需要先升级内核到3.10以上</li>\n</ul>\n<h3 id=\"下载安装包\"><a href=\"#下载安装包\" class=\"headerlink\" title=\"下载安装包\"></a>下载安装包</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget https://dl.k8s.io/v1.6.2/kubernetes-server-linux-amd64.tar.gz</div><div class=\"line\">tar -zxvf kubernetes-server-linux-amd64.tar.gz</div></pre></td></tr></table></figure>\n<h3 id=\"系统配置\"><a href=\"#系统配置\" class=\"headerlink\" title=\"系统配置\"></a>系统配置</h3><p>在各节点创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</div><div class=\"line\">net.bridge.bridge-nf-call-iptables = 1</div></pre></td></tr></table></figure>\n<p>执行命令使修改生效</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">setenforce 0</div><div class=\"line\">vi /etc/selinux/config</div><div class=\"line\">SELINUX=disabled</div></pre></td></tr></table></figure>\n<h3 id=\"ETCD集群，Docker安装\"><a href=\"#ETCD集群，Docker安装\" class=\"headerlink\" title=\"ETCD集群，Docker安装\"></a>ETCD集群，Docker安装</h3><p>etcd集群采用高可用，三节点部署，启用TLS。在每个node上安装好docker。</p>\n<h1 id=\"Kubernetes各组件TLS证书和密钥生成\"><a href=\"#Kubernetes各组件TLS证书和密钥生成\" class=\"headerlink\" title=\"Kubernetes各组件TLS证书和密钥生成\"></a>Kubernetes各组件TLS证书和密钥生成</h1><p>使用<a href=\"https://github.com/cloudflare/cfssl\">CFSSL</a>来生成证书和密钥。</p>\n<h3 id=\"生成CA证书和私钥\"><a href=\"#生成CA证书和私钥\" class=\"headerlink\" title=\"生成CA证书和私钥\"></a>生成CA证书和私钥</h3><p><code>ca-config.json</code>文件</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"signing\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"default\"</span>: &#123;</div><div class=\"line\">      <span class=\"attr\">\"expiry\"</span>: <span class=\"string\">\"87600h\"</span></div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"attr\">\"profiles\"</span>: &#123;</div><div class=\"line\">      <span class=\"attr\">\"frognew\"</span>: &#123;</div><div class=\"line\">        <span class=\"attr\">\"usages\"</span>: [</div><div class=\"line\">            <span class=\"string\">\"signing\"</span>,</div><div class=\"line\">            <span class=\"string\">\"key encipherment\"</span>,</div><div class=\"line\">            <span class=\"string\">\"server auth\"</span>,</div><div class=\"line\">            <span class=\"string\">\"client auth\"</span></div><div class=\"line\">        ],</div><div class=\"line\">        <span class=\"attr\">\"expiry\"</span>: <span class=\"string\">\"87600h\"</span></div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>创建CA证书签名请求配置ca-csr.json：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"kubernetes\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"k8s\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>使用cfssl生成CA证书和私钥</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div></pre></td></tr></table></figure>\n<h3 id=\"生成kube-apiserver证书和私钥\"><a href=\"#生成kube-apiserver证书和私钥\" class=\"headerlink\" title=\"生成kube-apiserver证书和私钥\"></a>生成kube-apiserver证书和私钥</h3><p>有三个master节点，”11.1.0.1”是api-server的service ip<br>apiserver-csr.json：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"string\">\"CN\"</span>: <span class=\"string\">\"kubernetes\"</span>,</div><div class=\"line\">    <span class=\"string\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"127.0.0.1\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"11.1.0.1\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default.svc\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default.svc.cluster\"</span>,</div><div class=\"line\">      <span class=\"string\">\"kubernetes.default.svc.cluster.local\"</span></div><div class=\"line\">    ],</div><div class=\"line\">    <span class=\"string\">\"key\"</span>: &#123;</div><div class=\"line\">        <span class=\"string\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">        <span class=\"string\">\"size\"</span>: 2048</div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"string\">\"names\"</span>: [</div><div class=\"line\">        &#123;</div><div class=\"line\">            <span class=\"string\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">            <span class=\"string\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">            <span class=\"string\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">            <span class=\"string\">\"O\"</span>: <span class=\"string\">\"k8s\"</span>,</div><div class=\"line\">            <span class=\"string\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">        &#125;</div><div class=\"line\">    ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>然后生成kube-apiserver的证书和私钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew apiserver-csr.json | cfssljson -bare apiserver</div><div class=\"line\">ls apiserver*</div><div class=\"line\">apiserver.csr  apiserver-csr.json  apiserver-key.pem  apiserver.pem</div></pre></td></tr></table></figure>\n<h3 id=\"创建kubernetes-admin客户端证书和私钥\"><a href=\"#创建kubernetes-admin客户端证书和私钥\" class=\"headerlink\" title=\"创建kubernetes-admin客户端证书和私钥\"></a>创建kubernetes-admin客户端证书和私钥</h3><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"kubernetes-admin\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:masters\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>生成kubernetes-admin的证书和私钥：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew admin-csr.json | cfssljson -bare admin</div></pre></td></tr></table></figure>\n<h3 id=\"生成kube-controller-manager证书和私钥\"><a href=\"#生成kube-controller-manager证书和私钥\" class=\"headerlink\" title=\"生成kube-controller-manager证书和私钥\"></a>生成kube-controller-manager证书和私钥</h3><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:kube-controller-manager\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:kube-controller-manager\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>生成证书和私钥</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew controller-manager-csr.json | cfssljson -bare controller-manager</div></pre></td></tr></table></figure>\n<h3 id=\"生成kube-scheduler证书和私钥\"><a href=\"#生成kube-scheduler证书和私钥\" class=\"headerlink\" title=\"生成kube-scheduler证书和私钥\"></a>生成kube-scheduler证书和私钥</h3><p>scheduler-csr.json：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:kube-scheduler\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">      <span class=\"string\">\"10.73.212.42\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.14\"</span>,</div><div class=\"line\">      <span class=\"string\">\"10.73.213.31\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr00\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr01\"</span>,</div><div class=\"line\">      <span class=\"string\">\"master-mgr02\"</span></div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:kube-scheduler\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>命令仍然类似</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew scheduler-csr.json | cfssljson -bare scheduler</div></pre></td></tr></table></figure>\n<h1 id=\"部署三个master节点\"><a href=\"#部署三个master节点\" class=\"headerlink\" title=\"部署三个master节点\"></a>部署三个master节点</h1><p>三个节点需要先拷贝好各组件的证书与密钥，参考的组件启动参数如下。</p>\n<p><em>注意：这里没有做高可用！</em></p>\n<h3 id=\"kube-apiserver\"><a href=\"#kube-apiserver\" class=\"headerlink\" title=\"kube-apiserver\"></a>kube-apiserver</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_apiserver/bin/kube-apiserver \\</div><div class=\"line\">--bind-address=0.0.0.0 --insecure-port=8080 \\</div><div class=\"line\">--secure-port=8443  \\</div><div class=\"line\">--etcd_servers=https://master-mgr00:2379,\\</div><div class=\"line\">https://master-mgr01:2379, \\</div><div class=\"line\">https://master-mgr02:2379 \\</div><div class=\"line\">--apiserver-count=3 --logtostderr=<span class=\"literal\">true</span> --allow-privileged=<span class=\"literal\">true</span> \\</div><div class=\"line\">--tls-cert-file=/home/work/kube_apiserver/conf/apiserver.pem \\</div><div class=\"line\">--tls-private-key-file=/home/work/kube_apiserver/conf/apiserver-key.pem \\</div><div class=\"line\">--client-ca-file=/home/work/kube_apiserver/conf/ca.pem \\</div><div class=\"line\">--service-account-key-file=/home/work/kube_apiserver/conf/ca-key.pem \\</div><div class=\"line\">--etcd-cafile=/home/work/kube_apiserver/conf/etcd/ca.pem \\</div><div class=\"line\">--etcd-certfile=/home/work/kube_apiserver/conf/etcd/etcd.pem \\</div><div class=\"line\">--etcd-keyfile=/home/work/kube_apiserver/conf/etcd/etcd-key.pem \\</div><div class=\"line\">--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,\\</div><div class=\"line\">PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds \\</div><div class=\"line\">--authorization-mode=RBAC --service-cluster-ip-range=11.1.0.0/16</div></pre></td></tr></table></figure>\n<h3 id=\"kube-controller-manager\"><a href=\"#kube-controller-manager\" class=\"headerlink\" title=\"kube-controller-manager\"></a>kube-controller-manager</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_controller_manager/bin/kube-controller-manager \\</div><div class=\"line\">--address=0.0.0.0 --master=http://127.0.0.1:8080 \\</div><div class=\"line\">--leader-elect=<span class=\"literal\">true</span> --logtostderr=<span class=\"literal\">true</span> \\</div><div class=\"line\"> --cluster-cidr=172.17.0.0/16 --allocate-node-cidrs=<span class=\"literal\">true</span> \\</div><div class=\"line\"> --service-cluster-ip-range=11.1.0.0/16 \\</div><div class=\"line\"> --service-account-private-key-file=/home/work/kube_controller_manager/conf/ca-key.pem \\</div><div class=\"line\"> --root-ca-file=/home/work/kube_controller_manager/conf/ca.pem</div></pre></td></tr></table></figure>\n<h3 id=\"kube-scheduler\"><a href=\"#kube-scheduler\" class=\"headerlink\" title=\"kube-scheduler\"></a>kube-scheduler</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_scheduler/bin/kube-scheduler \\</div><div class=\"line\">--address=0.0.0.0 --leader-elect=<span class=\"literal\">true</span> --logtostderr=<span class=\"literal\">true</span> \\</div><div class=\"line\">--master=http://127.0.0.1:8080</div></pre></td></tr></table></figure>\n<h1 id=\"Kubernetes-Node节点部署\"><a href=\"#Kubernetes-Node节点部署\" class=\"headerlink\" title=\"Kubernetes Node节点部署\"></a>Kubernetes Node节点部署</h1><ul>\n<li>部分机器要先安装下载<code>nsenter</code>这个二进制工具到bin目录</li>\n</ul>\n<h3 id=\"CNI安装\"><a href=\"#CNI安装\" class=\"headerlink\" title=\"CNI安装\"></a>CNI安装</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget https://github.com/containernetworking/cni/releases/download/v0.5.2/cni-amd64-v0.5.2.tgz</div><div class=\"line\">mkdir -p /opt/cni/bin</div><div class=\"line\">tar -zxvf cni-amd64-v0.5.2.tgz -C /opt/cni/bin</div><div class=\"line\">ls /opt/cni/bin/</div><div class=\"line\">bridge  cnitool  dhcp  flannel  host-local  ipvlan  loopback  macvlan  noop  ptp  tuning</div></pre></td></tr></table></figure>\n<h3 id=\"kubelet\"><a href=\"#kubelet\" class=\"headerlink\" title=\"kubelet\"></a>kubelet</h3><p>kubelet-csr.json：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:node\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:nodes\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kubelet-csr.json | cfssljson -bare kubelet</div></pre></td></tr></table></figure>\n<p>启动参数</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kubelet/bin/kubelet --address=0.0.0.0 \\</div><div class=\"line\">--api-servers=https://master-mgr00:8443,https://master-mgr00:8443,https://master-mgr00:8443 \\</div><div class=\"line\">--pod_infra_container_image=registry.baidu.com/public/pause:2.0 \\</div><div class=\"line\">--cluster-domain=cluster.local --cluster-dns=11.1.0.10 \\</div><div class=\"line\">--logtostderr=<span class=\"literal\">true</span> \\</div><div class=\"line\"> --client-ca-file=/home/work/kubelet/conf/ca.pem \\</div><div class=\"line\"> --tls-private-key-file=/home/work/kubelet/conf/kubelet-key.pem \\</div><div class=\"line\"> --tls-cert-file=/home/work/kubelet/conf/kubelet.pem \\</div><div class=\"line\"> --kubeconfig=/home/work/kubelet/conf/kubeconfig.yaml \\</div><div class=\"line\"> --allow-privileged=<span class=\"literal\">true</span> --cgroups-per-qos=<span class=\"literal\">false</span> \\</div><div class=\"line\"> --enforce-node-allocatable= --network-plugin=cni \\</div><div class=\"line\"> --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin \\</div><div class=\"line\"> --cadvisor-port=8086</div></pre></td></tr></table></figure>\n<h3 id=\"kube-proxy\"><a href=\"#kube-proxy\" class=\"headerlink\" title=\"kube-proxy\"></a>kube-proxy</h3><p>kube-proxy-csr.json:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"CN\"</span>: <span class=\"string\">\"system:kube-proxy\"</span>,</div><div class=\"line\">  <span class=\"attr\">\"hosts\"</span>: [</div><div class=\"line\">  ],</div><div class=\"line\">  <span class=\"attr\">\"key\"</span>: &#123;</div><div class=\"line\">    <span class=\"attr\">\"algo\"</span>: <span class=\"string\">\"rsa\"</span>,</div><div class=\"line\">    <span class=\"attr\">\"size\"</span>: <span class=\"number\">2048</span></div><div class=\"line\">  &#125;,</div><div class=\"line\">  <span class=\"attr\">\"names\"</span>: [</div><div class=\"line\">    &#123;</div><div class=\"line\">      <span class=\"attr\">\"C\"</span>: <span class=\"string\">\"CN\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"ST\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"L\"</span>: <span class=\"string\">\"BeiJing\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"O\"</span>: <span class=\"string\">\"system:kube-proxy\"</span>,</div><div class=\"line\">      <span class=\"attr\">\"OU\"</span>: <span class=\"string\">\"cloudnative\"</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  ]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew kube-proxy-csr.json | cfssljson -bare kube-proxy</div></pre></td></tr></table></figure>\n<p>生成kubeconfig：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">export</span> KUBE_APISERVER=<span class=\"string\">\"https://master-mgr00:8443\"</span></div><div class=\"line\"><span class=\"comment\"># set-cluster</span></div><div class=\"line\">kubectl config <span class=\"built_in\">set</span>-cluster kubernetes \\</div><div class=\"line\">  --certificate-authority=/home/work/kube_proxy/conf/ca.pem \\</div><div class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</div><div class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</div><div class=\"line\">  --kubeconfig=kube-proxy.conf</div><div class=\"line\"><span class=\"comment\"># set-credentials</span></div><div class=\"line\">kubectl config <span class=\"built_in\">set</span>-credentials system:kube-proxy \\</div><div class=\"line\">  --client-certificate=/home/work/kube_proxy/conf/kube-proxy.pem \\</div><div class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</div><div class=\"line\">  --client-key=/home/work/kube_proxy/conf/kube-proxy-key.pem \\</div><div class=\"line\">  --kubeconfig=kube-proxy.conf</div><div class=\"line\"><span class=\"comment\"># set-context</span></div><div class=\"line\">kubectl config <span class=\"built_in\">set</span>-context system:kube-proxy@kubernetes \\</div><div class=\"line\">  --cluster=kubernetes \\</div><div class=\"line\">  --user=system:kube-proxy \\</div><div class=\"line\">  --kubeconfig=kube-proxy.conf</div><div class=\"line\"><span class=\"comment\"># set default context</span></div><div class=\"line\">kubectl config use-context system:kube-proxy@kubernetes --kubeconfig=kube-proxy.conf</div></pre></td></tr></table></figure>\n<p>启动命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">/home/work/kube_proxy/bin/kube-proxy --master=https://master-mgr00:8443 \\</div><div class=\"line\">--kubeconfig=/home/work/kube_proxy/conf/kube-proxy.conf \\</div><div class=\"line\">--proxy-mode=iptables --cluster-cidr=172.17.0.0/16 \\</div><div class=\"line\">--logtostderr=<span class=\"literal\">true</span></div></pre></td></tr></table></figure>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>后续还要部署flannel，dns等其他插件，将写在下一篇博客里了。</p>\n"},{"title":"docker启动容器后，daemon crash问题，An error occurred trying to connect","date":"2017-04-16T02:44:54.000Z","_content":"最近运行docker run 命令后出现了，容器无法启动的情况，出现了以下信息。\n\n```\n$ docker run -d  registry.baidu.com/public/nginx_1-8-0:1.0.1\n33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307\n\nAn error occurred trying to connect: Post http:///var/run/docker.sock/v1.21/containers/33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307/start: EOF\n```\n\n查看日志后发现panic,docker进程挂了。\n```\nruntime: goroutine stack exceeds 1000000000-byte limit\nfatal error: stack overflow\n\nruntime stack:\nruntime.throw(0x1d967b9)\n        /usr/local/go/src/runtime/panic.go:491 +0xad\nruntime.newstack()\n        /usr/local/go/src/runtime/stack.c:784 +0x555\nruntime.morestack()\n        /usr/local/go/src/runtime/asm_amd64.s:324 +0x7e\ngoroutine 67 [stack growth]:\npath/filepath.(*lazybuf).append(0xc228c102a8, 0x2f)\n        /usr/local/go/src/path/filepath/path.go:35 fp=0xc228c101f0 sp=0xc228c101e8\npath/filepath.Clean(0xc208869e60, 0x1, 0x0, 0x0)\n        /usr/local/go/src/path/filepath/path.go:103 +0x1e4 fp=0xc228c102f8 sp=0xc228c101f0\npath/filepath.Dir(0xc208869e60, 0x1, 0x0, 0x0)\n        /usr/local/go/src/path/filepath/path.go:454 +0xdd fp=0xc228c10360 sp=0xc228c102f8\ngithub.com/opencontainers/runc/libcontainer/cgroups/fs.(*CpusetGroup).ensureParent(0x1dbd8c0, 0xc208869e60, 0x1, 0xc2088b128d, 0x8, 0x0, 0x0)\n        /go/src/github.com/docker/docker/vendor/src/github.com/opencontainers/runc/libcontainer/cgroups/fs/cpuset.go:91 +0x50 fp=0xc228c103e0 sp=0xc228c10360\ngoroutine 10 [chan receive, 1 minutes]:\ngithub.com/docker/docker/api/server.(*Server).ServeAPI(0xc208037980, 0x0, 0x0)\n        /go/src/github.com/docker/docker/api/server/server.go:94 +0x1b6\nmain.func·007()\n        /go/src/github.com/docker/docker/docker/daemon.go:255 +0x3b\ncreated by main.(*DaemonCli).CmdDaemon\n        /go/src/github.com/docker/docker/docker/daemon.go:261 +0x1571        \n\n```\n\ngoogle之后，发现这个[ISSUE](https://github.com/docker/docker/issues/18048) 有点类似，bschiffthaler将内核升级到`3.13.0-70`之后，修复了此问题。\n\n\n> @tiborvass Seems it was an issue with the kernel. The error persisted through a reboot, but upgrading the kernel to 3.13.0-70 fixed the issue. We have other machines with kernels older than 3.13.0-34 and docker runs just fine, I would chuck it up to a systems \"hiccup\".\nI'll be closing the issue with this.\n\n此问题也可能与机器有关，相同内核的不同机器，也会出现此问题。\n按照ISSUE中所说，在1.10以上版本已经修复此问题。\n\n>@sanwan the error discussed here was in docker 1.10 and older, and was resolved; if you're running the current version of docker, please open a new issue with more details (as requested in the bug report template), or search if there's an existing open issue.\n\n\n\n","source":"_posts/docker-run启动daemon-crash问题，An-error-occurred-trying-to-connect.md","raw":"---\ntitle: docker启动容器后，daemon crash问题，An error occurred trying to connect\ndate: 2017-04-16 10:44:54\ntags:\n---\n最近运行docker run 命令后出现了，容器无法启动的情况，出现了以下信息。\n\n```\n$ docker run -d  registry.baidu.com/public/nginx_1-8-0:1.0.1\n33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307\n\nAn error occurred trying to connect: Post http:///var/run/docker.sock/v1.21/containers/33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307/start: EOF\n```\n\n查看日志后发现panic,docker进程挂了。\n```\nruntime: goroutine stack exceeds 1000000000-byte limit\nfatal error: stack overflow\n\nruntime stack:\nruntime.throw(0x1d967b9)\n        /usr/local/go/src/runtime/panic.go:491 +0xad\nruntime.newstack()\n        /usr/local/go/src/runtime/stack.c:784 +0x555\nruntime.morestack()\n        /usr/local/go/src/runtime/asm_amd64.s:324 +0x7e\ngoroutine 67 [stack growth]:\npath/filepath.(*lazybuf).append(0xc228c102a8, 0x2f)\n        /usr/local/go/src/path/filepath/path.go:35 fp=0xc228c101f0 sp=0xc228c101e8\npath/filepath.Clean(0xc208869e60, 0x1, 0x0, 0x0)\n        /usr/local/go/src/path/filepath/path.go:103 +0x1e4 fp=0xc228c102f8 sp=0xc228c101f0\npath/filepath.Dir(0xc208869e60, 0x1, 0x0, 0x0)\n        /usr/local/go/src/path/filepath/path.go:454 +0xdd fp=0xc228c10360 sp=0xc228c102f8\ngithub.com/opencontainers/runc/libcontainer/cgroups/fs.(*CpusetGroup).ensureParent(0x1dbd8c0, 0xc208869e60, 0x1, 0xc2088b128d, 0x8, 0x0, 0x0)\n        /go/src/github.com/docker/docker/vendor/src/github.com/opencontainers/runc/libcontainer/cgroups/fs/cpuset.go:91 +0x50 fp=0xc228c103e0 sp=0xc228c10360\ngoroutine 10 [chan receive, 1 minutes]:\ngithub.com/docker/docker/api/server.(*Server).ServeAPI(0xc208037980, 0x0, 0x0)\n        /go/src/github.com/docker/docker/api/server/server.go:94 +0x1b6\nmain.func·007()\n        /go/src/github.com/docker/docker/docker/daemon.go:255 +0x3b\ncreated by main.(*DaemonCli).CmdDaemon\n        /go/src/github.com/docker/docker/docker/daemon.go:261 +0x1571        \n\n```\n\ngoogle之后，发现这个[ISSUE](https://github.com/docker/docker/issues/18048) 有点类似，bschiffthaler将内核升级到`3.13.0-70`之后，修复了此问题。\n\n\n> @tiborvass Seems it was an issue with the kernel. The error persisted through a reboot, but upgrading the kernel to 3.13.0-70 fixed the issue. We have other machines with kernels older than 3.13.0-34 and docker runs just fine, I would chuck it up to a systems \"hiccup\".\nI'll be closing the issue with this.\n\n此问题也可能与机器有关，相同内核的不同机器，也会出现此问题。\n按照ISSUE中所说，在1.10以上版本已经修复此问题。\n\n>@sanwan the error discussed here was in docker 1.10 and older, and was resolved; if you're running the current version of docker, please open a new issue with more details (as requested in the bug report template), or search if there's an existing open issue.\n\n\n\n","slug":"docker-run启动daemon-crash问题，An-error-occurred-trying-to-connect","published":1,"updated":"2017-04-16T03:06:10.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj2x8eiel0002mcon3nifgjer","content":"<p>最近运行docker run 命令后出现了，容器无法启动的情况，出现了以下信息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ docker run -d  registry.baidu.com/public/nginx_1-8-0:1.0.1</div><div class=\"line\">33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307</div><div class=\"line\"></div><div class=\"line\">An error occurred trying to connect: Post http:///var/run/docker.sock/v1.21/containers/33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307/start: EOF</div></pre></td></tr></table></figure>\n<p>查看日志后发现panic,docker进程挂了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">runtime: goroutine stack exceeds 1000000000-byte limit</div><div class=\"line\">fatal error: stack overflow</div><div class=\"line\"></div><div class=\"line\">runtime stack:</div><div class=\"line\">runtime.throw(0x1d967b9)</div><div class=\"line\">        /usr/local/go/src/runtime/panic.go:491 +0xad</div><div class=\"line\">runtime.newstack()</div><div class=\"line\">        /usr/local/go/src/runtime/stack.c:784 +0x555</div><div class=\"line\">runtime.morestack()</div><div class=\"line\">        /usr/local/go/src/runtime/asm_amd64.s:324 +0x7e</div><div class=\"line\">goroutine 67 [stack growth]:</div><div class=\"line\">path/filepath.(*lazybuf).append(0xc228c102a8, 0x2f)</div><div class=\"line\">        /usr/local/go/src/path/filepath/path.go:35 fp=0xc228c101f0 sp=0xc228c101e8</div><div class=\"line\">path/filepath.Clean(0xc208869e60, 0x1, 0x0, 0x0)</div><div class=\"line\">        /usr/local/go/src/path/filepath/path.go:103 +0x1e4 fp=0xc228c102f8 sp=0xc228c101f0</div><div class=\"line\">path/filepath.Dir(0xc208869e60, 0x1, 0x0, 0x0)</div><div class=\"line\">        /usr/local/go/src/path/filepath/path.go:454 +0xdd fp=0xc228c10360 sp=0xc228c102f8</div><div class=\"line\">github.com/opencontainers/runc/libcontainer/cgroups/fs.(*CpusetGroup).ensureParent(0x1dbd8c0, 0xc208869e60, 0x1, 0xc2088b128d, 0x8, 0x0, 0x0)</div><div class=\"line\">        /go/src/github.com/docker/docker/vendor/src/github.com/opencontainers/runc/libcontainer/cgroups/fs/cpuset.go:91 +0x50 fp=0xc228c103e0 sp=0xc228c10360</div><div class=\"line\">goroutine 10 [chan receive, 1 minutes]:</div><div class=\"line\">github.com/docker/docker/api/server.(*Server).ServeAPI(0xc208037980, 0x0, 0x0)</div><div class=\"line\">        /go/src/github.com/docker/docker/api/server/server.go:94 +0x1b6</div><div class=\"line\">main.func·007()</div><div class=\"line\">        /go/src/github.com/docker/docker/docker/daemon.go:255 +0x3b</div><div class=\"line\">created by main.(*DaemonCli).CmdDaemon</div><div class=\"line\">        /go/src/github.com/docker/docker/docker/daemon.go:261 +0x1571</div></pre></td></tr></table></figure></p>\n<p>google之后，发现这个<a href=\"https://github.com/docker/docker/issues/18048\" target=\"_blank\" rel=\"external\">ISSUE</a> 有点类似，bschiffthaler将内核升级到<code>3.13.0-70</code>之后，修复了此问题。</p>\n<blockquote>\n<p>@tiborvass Seems it was an issue with the kernel. The error persisted through a reboot, but upgrading the kernel to 3.13.0-70 fixed the issue. We have other machines with kernels older than 3.13.0-34 and docker runs just fine, I would chuck it up to a systems “hiccup”.<br>I’ll be closing the issue with this.</p>\n</blockquote>\n<p>此问题也可能与机器有关，相同内核的不同机器，也会出现此问题。<br>按照ISSUE中所说，在1.10以上版本已经修复此问题。</p>\n<blockquote>\n<p>@sanwan the error discussed here was in docker 1.10 and older, and was resolved; if you’re running the current version of docker, please open a new issue with more details (as requested in the bug report template), or search if there’s an existing open issue.</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<p>最近运行docker run 命令后出现了，容器无法启动的情况，出现了以下信息。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ docker run -d  registry.baidu.com/public/nginx_1-8-0:1.0.1</div><div class=\"line\">33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307</div><div class=\"line\"></div><div class=\"line\">An error occurred trying to connect: Post http:///var/run/docker.sock/v1.21/containers/33d0ea46c4015f5ec6dee16475b0e66b3077cca6214c6d797c5967bbe2279307/start: EOF</div></pre></td></tr></table></figure>\n<p>查看日志后发现panic,docker进程挂了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">runtime: goroutine stack exceeds 1000000000-byte limit</div><div class=\"line\">fatal error: stack overflow</div><div class=\"line\"></div><div class=\"line\">runtime stack:</div><div class=\"line\">runtime.throw(0x1d967b9)</div><div class=\"line\">        /usr/local/go/src/runtime/panic.go:491 +0xad</div><div class=\"line\">runtime.newstack()</div><div class=\"line\">        /usr/local/go/src/runtime/stack.c:784 +0x555</div><div class=\"line\">runtime.morestack()</div><div class=\"line\">        /usr/local/go/src/runtime/asm_amd64.s:324 +0x7e</div><div class=\"line\">goroutine 67 [stack growth]:</div><div class=\"line\">path/filepath.(*lazybuf).append(0xc228c102a8, 0x2f)</div><div class=\"line\">        /usr/local/go/src/path/filepath/path.go:35 fp=0xc228c101f0 sp=0xc228c101e8</div><div class=\"line\">path/filepath.Clean(0xc208869e60, 0x1, 0x0, 0x0)</div><div class=\"line\">        /usr/local/go/src/path/filepath/path.go:103 +0x1e4 fp=0xc228c102f8 sp=0xc228c101f0</div><div class=\"line\">path/filepath.Dir(0xc208869e60, 0x1, 0x0, 0x0)</div><div class=\"line\">        /usr/local/go/src/path/filepath/path.go:454 +0xdd fp=0xc228c10360 sp=0xc228c102f8</div><div class=\"line\">github.com/opencontainers/runc/libcontainer/cgroups/fs.(*CpusetGroup).ensureParent(0x1dbd8c0, 0xc208869e60, 0x1, 0xc2088b128d, 0x8, 0x0, 0x0)</div><div class=\"line\">        /go/src/github.com/docker/docker/vendor/src/github.com/opencontainers/runc/libcontainer/cgroups/fs/cpuset.go:91 +0x50 fp=0xc228c103e0 sp=0xc228c10360</div><div class=\"line\">goroutine 10 [chan receive, 1 minutes]:</div><div class=\"line\">github.com/docker/docker/api/server.(*Server).ServeAPI(0xc208037980, 0x0, 0x0)</div><div class=\"line\">        /go/src/github.com/docker/docker/api/server/server.go:94 +0x1b6</div><div class=\"line\">main.func·007()</div><div class=\"line\">        /go/src/github.com/docker/docker/docker/daemon.go:255 +0x3b</div><div class=\"line\">created by main.(*DaemonCli).CmdDaemon</div><div class=\"line\">        /go/src/github.com/docker/docker/docker/daemon.go:261 +0x1571</div></pre></td></tr></table></figure></p>\n<p>google之后，发现这个<a href=\"https://github.com/docker/docker/issues/18048\">ISSUE</a> 有点类似，bschiffthaler将内核升级到<code>3.13.0-70</code>之后，修复了此问题。</p>\n<blockquote>\n<p>@tiborvass Seems it was an issue with the kernel. The error persisted through a reboot, but upgrading the kernel to 3.13.0-70 fixed the issue. We have other machines with kernels older than 3.13.0-34 and docker runs just fine, I would chuck it up to a systems “hiccup”.<br>I’ll be closing the issue with this.</p>\n</blockquote>\n<p>此问题也可能与机器有关，相同内核的不同机器，也会出现此问题。<br>按照ISSUE中所说，在1.10以上版本已经修复此问题。</p>\n<blockquote>\n<p>@sanwan the error discussed here was in docker 1.10 and older, and was resolved; if you’re running the current version of docker, please open a new issue with more details (as requested in the bug report template), or search if there’s an existing open issue.</p>\n</blockquote>\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[],"Tag":[]}}